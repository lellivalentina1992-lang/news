<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Edicola Valentina</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; line-height: 1.6; max-width: 1000px; margin: auto; background: #fdfdfd; color: #1a1a1a; }
        button { padding: 12px; margin: 5px; font-size: 1.1rem; cursor: pointer; border: 2px solid #333; border-radius: 8px; background: #fff; font-weight: bold; }
        .btn-super-tg { background: #d93025; color: white; border: none; width: 100%; height: 70px; font-size: 1.3rem; margin-bottom: 20px; }
        input { padding: 12px; font-size: 1.1rem; border: 2px solid #767676; border-radius: 4px; }
        .chat-area { background: #eef6ff; padding: 25px; border: 2px solid #005a87; border-radius: 8px; margin-top: 40px; }
        article { border-left: 8px solid #005a87; padding: 15px; margin-bottom: 20px; background: #fff; }
    </style>
</head>
<body>
    <header><h1>La mia Edicola: Valentina</h1></header>

    <section>
        <h2>Configurazione</h2>
        <input type="password" id="api-key-input" placeholder="Incolla Chiave API">
        <button onclick="salvaChiave()">Salva Chiave</button>
    </section>

    <section>
        <h2>Generazione TG Globale</h2>
        <label for="input-ore">Quante ore vuoi analizzare? </label>
        <input type="number" id="input-ore" style="width: 70px;" value="24">
        <button class="btn-super-tg" onclick="generaSuperTG()">Genera Super TG Globale (Tutte le categorie)</button>
    </section>

    <section>
        <h2>Esplora Categorie</h2>
        <nav>
            <button onclick="caricaGruppo('ciechi')">Ciechi</button>
            <button onclick="caricaGruppo('news')">News</button>
            <button onclick="caricaGruppo('approfondimenti')">Approfondimenti</button>
            <button onclick="caricaGruppo('psicologia')">Psicologia</button>
            <button onclick="caricaGruppo('roma')">Roma</button>
        </nav>
    </section>

    <main id="main-content" aria-live="polite">
        <h2 id="titolo-sezione">Le tue notizie compariranno qui</h2>
        <div id="container-notizie"></div>
    </main>

    <section id="risposta-ai-container" class="chat-area" style="display:none;">
        <h2 id="titolo-tg">Il tuo TG Personalizzato</h2>
        <div id="risposta-ai" aria-live="assertive"></div>
    </section>

    <script>
        let tutteLeNotizie = [];
        const feedMap = {
            ciechi: [{n:"Reddit Blind", u:"https://www.reddit.com/r/Blind.rss"}, {n:"NVDA-it", u:"https://groups.io/g/nvda-it/rss"}, {n:"AppleVis", u:"https://www.applevis.com/blog/feed"}],
            news: [{n:"ANSA", u:"https://www.ansa.it/sito/ansait_rss.xml"}, {n:"Sole 24 Ore", u:"https://www.ilsole24ore.com/rss/italia.xml"}],
            approfondimenti: [{n:"Il Post", u:"https://www.ilpost.it/feed/"}, {n:"Valigia Blu", u:"https://www.valigiablu.it/feed/"}, {n:"Il Tascabile", u:"https://www.iltascabile.com/feed/"}],
            psicologia: [{n:"State of Mind", u:"https://www.stateofmind.it/category/articoli/feed/"}, {n:"Mind Le Scienze", u:"https://www.lescienze.it/topics/mente-e-cervello/rss"}, {n:"Doppiozero Psiche", u:"https://www.doppiozero.com/tag/psicologia/feed/"}],
            roma: [{n:"Corriere Roma", u:"https://www.corriere.it/dynamic-feed/rss/section/roma.xml"}, {n:"RomaToday", u:"https://www.romatoday.it/rss"}, {n:"ATAC", u:"https://www.atac.roma.it/feeds/lo-stato-del-servizio-in-tempo-reale"}, {n:"Tiburno TV", u:"https://tiburno.tv/feed/"}]
        };

        async function scaricaFeed(listaSiti) {
            const promesse = listaSiti.map(sito => 
                fetch(`/api/fetch-rss?url=${encodeURIComponent(sito.u)}`)
                .then(r => r.text())
                .then(xml => {
                    const xmlDoc = new DOMParser().parseFromString(xml, "text/xml");
                    Array.from(xmlDoc.querySelectorAll("item")).forEach(item => {
                        const dRaw = item.querySelector("pubDate")?.textContent || "";
                        tutteLeNotizie.push({ 
                            fonte: sito.n, titolo: item.querySelector("title")?.textContent || "No titolo", 
                            timestamp: new Date(dRaw).getTime() || 0, dataTesto: dRaw
                        });
                    });
                })
            );
            await Promise.all(promesse);
        }

        async function caricaGruppo(cat) {
            tutteLeNotizie = [];
            document.getElementById('titolo-sezione').innerText = `Caricamento ${cat}...`;
            await scaricaFeed(feedMap[cat]);
            renderizza();
        }

        function renderizza() {
            const cont = document.getElementById('container-notizie');
            cont.innerHTML = "";
            tutteLeNotizie.sort((a,b) => b.timestamp - a.timestamp).forEach(n => {
                cont.innerHTML += `<article><strong>${n.fonte}</strong><h3>${n.titolo}</h3></article>`;
            });
        }

        async function generaSuperTG() {
            tutteLeNotizie = [];
            const resBox = document.getElementById('risposta-ai');
            const ore = document.getElementById('input-ore').value;
            document.getElementById('risposta-ai-container').style.display = "block";
            resBox.innerHTML = "<h3>Recupero di tutti i feed in corso...</h3>";

            let tutti = [];
            Object.keys(feedMap).forEach(k => tutti = tutti.concat(feedMap[k]));
            await scaricaFeed(tutti);

            const limite = Date.now() - (ore * 60 * 60 * 1000);
            const filtrate = tutteLeNotizie.filter(n => n.timestamp > limite);
            
            resBox.innerHTML = "<h3>Gemini 3 Pro sta scrivendo il Super TG Esaustivo...</h3>";
            let contesto = filtrate.map(n => `[${n.fonte}] ${n.titolo}`).join(". ");
            
            const key = localStorage.getItem('google_api_key');
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messaggio: `Fai il TG di tutte queste news delle ultime ${ore} ore.`, contesto: contesto, apiKey: key })
            });
            const data = await response.json();
            resBox.innerHTML = `<div>${data.risposta}</div>`;
        }

        function salvaChiave() { localStorage.setItem('google_api_key', document.getElementById('api-key-input').value); }
    </script>
</body>
</html>