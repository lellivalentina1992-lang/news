<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>La mia Edicola: Valentina</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; line-height: 1.6; max-width: 1000px; margin: auto; background: #fdfdfd; color: #1a1a1a; }
        button { padding: 12px; margin: 5px; font-size: 1.1rem; cursor: pointer; border: 2px solid #333; border-radius: 8px; background: #fff; font-weight: bold; }
        .btn-filtro { background: #e9ecef; border-color: #666; font-size: 0.95rem; }
        input { padding: 12px; font-size: 1.1rem; margin: 10px 0; border: 2px solid #767676; border-radius: 4px; width: 85%; }
        section { border-bottom: 3px solid #eee; padding: 20px 0; }
        article { border-left: 8px solid #005a87; padding: 15px; margin-bottom: 25px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .info-tag { font-weight: bold; color: #d93025; font-size: 0.9rem; display: block; margin-bottom: 5px; }
        .chat-area { background: #eef6ff; padding: 25px; border: 2px solid #005a87; border-radius: 8px; margin-top: 40px; }
    </style>
</head>
<body>
    <header><h1>La mia Edicola: Valentina</h1></header>

    <section>
        <h2>Configurazione</h2>
        <input type="password" id="api-key-input" placeholder="Incolla API Key per la Chat">
        <button onclick="salvaChiave()">Salva Chiave</button>
        <p id="stato-chiave" aria-live="polite"></p>
    </section>

    <section aria-labelledby="titolo-feed">
        <h2 id="titolo-feed">I miei Feed (Scegli una categoria)</h2>
        <nav>
            <button onclick="caricaTuttoIlGruppo('ciechi')">Ciechi</button>
            <button onclick="caricaTuttoIlGruppo('news')">News Nazionali</button>
            <button onclick="caricaTuttoIlGruppo('approfondimenti')">Approfondimenti</button>
            <button onclick="caricaTuttoIlGruppo('psicologia')">Psicologia</button>
            <button onclick="caricaTuttoIlGruppo('roma')">Roma</button>
            <button onclick="caricaTuttoIlGruppo('tecnologia')">Tecnologia</button>
        </nav>
    </section>

    <section id="sezione-filtri" style="display:none;" aria-labelledby="titolo-filtri">
        <h3 id="titolo-filtri">Filtra per sito specifico</h3>
        <div id="container-filtri"></div>
    </section>

    <main id="main-content" aria-live="polite">
        <h2 id="titolo-sezione">Nessuna categoria selezionata</h2>
        <div id="container-notizie"></div>
    </main>

    <section class="chat-area">
        <h2>Chiedi all'Assistente</h2>
        <button id="toggle-web" onclick="toggleWeb()">Ricerca Web: OFF</button><br>
        <input type="text" id="input-chat" placeholder="Chiedi sui feed carichi...">
        <button onclick="inviaAI()">Invia Domanda</button>
        <div id="risposta-ai" aria-live="assertive" style="margin-top: 20px;"></div>
    </section>

    <script>
        let webAttiva = false;
        let contestoFeed = "";
        let tutteLeNotizie = []; 
        const SEARCH_ID = "43edcb6f7c3854b7a";

        const feedMap = {
            ciechi: [
                {n: "Reddit - r/Blind", u: "https://www.reddit.com/r/Blind.rss"},
                {n: "Reddit - r/Blind (Ricerca)", u: "https://www.reddit.com/r/Blind/search/.rss?q=android+OR+talkback+OR+screenreader&restrict_sr=1&sort=new"},
                {n: "Reddit - r/AudioGames", u: "https://www.reddit.com/r/AudioGames.rss"},
                {n: "Reddit - r/AssistiveTechnology", u: "https://www.reddit.com/r/AssistiveTechnology.rss"},
                {n: "Blind Android Users (Podcast)", u: "https://blindandroidusers.com/feed/podcast/"},
                {n: "Blind Android Users (Gruppo)", u: "https://groups.io/g/blindandroidusers/rss"},
                {n: "NVDA-it (Gruppo)", u: "https://groups.io/g/nvda-it/rss"},
                {n: "NVDA (Gruppo)", u: "https://nvda.groups.io/g/nvda/rss"},
                {n: "NVDA Addons (Gruppo)", u: "https://nvda-addons.groups.io/g/nvda-addons/rss"},
                {n: "JFW (Gruppo)", u: "https://jfw.groups.io/g/main/rss"},
                {n: "AppleVis: Blogs", u: "https://www.applevis.com/blog/feed"},
                {n: "AppleVis: Podcast", u: "https://www.applevis.com/podcasts/feed"}
            ],
            news: [
                {n: "ANSA", u: "https://www.ansa.it/sito/ansait_rss.xml"},
                {n: "la Repubblica", u: "https://www.repubblica.it/rss/cronaca/rss2.0.xml"},
                {n: "La Stampa", u: "https://www.lastampa.it/rss/copertina.xml"},
                {n: "Il Sole 24 Ore", u: "https://www.ilsole24ore.com/rss/italia.xml"},
                {n: "Il Messaggero", u: "https://www.ilmessaggero.it/rss.php"},
                {n: "Sky TG24 Home", u: "https://tg24.sky.it/rss/tg24.xml"},
                {n: "Sky TG24 Cronaca", u: "https://tg24.sky.it/rss/tg24_cronaca.xml"},
                {n: "Sky TG24 Mondo", u: "https://tg24.sky.it/rss/tg24_mondo.xml"}
            ],
            approfondimenti: [
                {n: "Internazionale", u: "https://www.internazionale.it/sitemaps/rss.xml"},
                {n: "Open", u: "https://www.open.online/feed/"},
                {n: "Valigia Blu", u: "https://www.valigiablu.it/feed/"},
                {n: "Scomodo", u: "https://scomodo.org/feed/"},
                {n: "The Vision", u: "https://thevision.com/feed/"},
                {n: "Rivista Studio", u: "https://www.rivistastudio.com/feed/"},
                {n: "Bufale.net", u: "https://www.bufale.net/feed/"},
                {n: "Formiche", u: "https://formiche.net/feed/"},
                {n: "Pandora Rivista", u: "https://www.pandorarivista.it/feed/"},
                {n: "Domani", u: "https://www.editorialedomani.it/rss"},
                {n: "L'Indipendente", u: "https://www.lindipendente.online/feed/"},
                {n: "2duerighe", u: "https://www.2duerighe.com/feed/"},
                {n: "Giano News", u: "https://www.giano.news/feed/"},
                {n: "Il Post", u: "https://www.ilpost.it/feed/"},
                {n: "Wired - Diritti", u: "https://www.wired.it/feed/rss/internet/diritti/"},
                {n: "Il Tascabile", u: "https://www.iltascabile.com/feed/"},
                {n: "All Music Italia", u: "https://www.allmusicitalia.it/feed"},
                {n: "Digital-News", u: "https://www.digital-news.it/rss.php"},
                {n: "FM-World", u: "https://www.fm-world.it/feed/"}
            ],
            psicologia: [
                {n: "State of Mind", u: "https://www.stateofmind.it/category/articoli/feed/"},
                {n: "Mind - Le Scienze", u: "https://www.lescienze.it/topics/mente-e-cervello/rss"},
                {n: "Doppiozero - Psiche", u: "https://www.doppiozero.com/tag/psicologia/feed/"},
                {n: "La Mente è Meravigliosa", u: "https://lamenteemeravigliosa.it/feed/"},
                {n: "Psypedia", u: "https://www.psypedia.it/feed/"},
                {n: "Psiche - Santagostino", u: "https://psiche.santagostino.it/feed/"},
                {n: "Psychology Today", u: "https://www.psychologytoday.com/intl/front/feed"},
                {n: "PsyPost", u: "https://www.psypost.org/feed"}
            ],
            roma: [
                {n: "Corriere Roma", u: "https://www.corriere.it/dynamic-feed/rss/section/roma.xml"},
                {n: "RomaToday", u: "https://www.romatoday.it/rss"},
                {n: "ANSA - Lazio", u: "https://www.ansa.it/lazio/notizie/lazio_rss.xml"},
                {n: "TGR Lazio", u: "https://www.rainews.it/tgr/lazio/rss/tutti"},
                {n: "Tiburno TV", u: "https://tiburno.tv/feed/"},
                {n: "Canale Dieci", u: "https://canaledieci.it/feed/"},
                {n: "Il Faro Online", u: "https://www.ilfaroonline.it/feed/"},
                {n: "Radio Roma", u: "https://www.radioroma.it/feed/"},
                {n: "Roma Sociale", u: "https://romasociale.com/feed/"},
                {n: "ATAC", u: "https://www.atac.roma.it/feeds/lo-stato-del-servizio-in-tempo-reale"}
            ],
            tecnologia: [
                {n: "Reddit - r/technews", u: "https://www.reddit.com/r/technews.rss"},
                {n: "Google News - AI", u: "https://news.google.com/rss/search?q=intelligenza+artificiale+OR+Gemini+OR+ChatGPT&hl=it&gl=IT&ceid=IT:it"},
                {n: "Sky TG24 - Tecnologia", u: "https://tg24.sky.it/rss/tg24_tecnologia.xml"}
            ]
        };

        function ottieniTimestamp(stringaData) {
            if (!stringaData) return 0;
            const d = new Date(stringaData);
            return isNaN(d.getTime()) ? 0 : d.getTime();
        }

        function formattaData(stringaData) {
            if (!stringaData) return "Data non disponibile";
            const d = new Date(stringaData);
            if (isNaN(d.getTime())) return "Data recente";
            return d.toLocaleString('it-IT', { day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' });
        }

        async function caricaTuttoIlGruppo(cat) {
            const contNotizie = document.getElementById('container-notizie');
            const titSezione = document.getElementById('titolo-sezione');
            const contFiltri = document.getElementById('container-filtri');
            const sezFiltri = document.getElementById('sezione-filtri');

            titSezione.innerText = `Aggiornamento in corso per ${cat}...`;
            contNotizie.innerHTML = "";
            contFiltri.innerHTML = "";
            sezFiltri.style.display = "block";
            tutteLeNotizie = [];
            contestoFeed = "";

            const btnAll = document.createElement('button');
            btnAll.innerText = "Mostra tutti i siti (Ordina per data)";
            btnAll.className = "btn-filtro";
            btnAll.onclick = () => renderizzaNotizie();
            contFiltri.appendChild(btnAll);

            feedMap[cat].forEach(sito => {
                const btn = document.createElement('button');
                btn.innerText = sito.n;
                btn.className = "btn-filtro";
                btn.onclick = () => renderizzaNotizie(sito.n);
                contFiltri.appendChild(btn);
            });

            const promesse = feedMap[cat].map(sito => 
                fetch(`/api/fetch-rss?url=${encodeURIComponent(sito.u)}`)
                .then(r => r.text())
                .then(xml => {
                    const xmlDoc = new DOMParser().parseFromString(xml, "text/xml");
                    const items = Array.from(xmlDoc.querySelectorAll("item"));
                    items.forEach(item => {
                        const t = item.querySelector("title")?.textContent || "Senza titolo";
                        const l = item.querySelector("link")?.textContent || "#";
                        const dRaw = item.querySelector("pubDate")?.textContent || item.querySelector("date")?.textContent || "";
                        
                        tutteLeNotizie.push({ 
                            fonte: sito.n, 
                            titolo: t, 
                            link: l, 
                            dataTesto: formattaData(dRaw),
                            timestamp: ottieniTimestamp(dRaw)
                        });
                    });
                }).catch(() => console.log("Errore su: " + sito.n))
            );

            await Promise.all(promesse);
            
            // ORDINAMENTO CRONOLOGICO (Dalla più recente alla più vecchia)
            tutteLeNotizie.sort((a, b) => b.timestamp - a.timestamp);
            
            renderizzaNotizie();
            titSezione.innerText = `Categoria ${cat}: trovate ${tutteLeNotizie.length} notizie ordinate per data.`;
        }

        function renderizzaNotizie(filtro = null) {
            const cont = document.getElementById('container-notizie');
            cont.innerHTML = "";
            contestoFeed = "";
            const notizieDaMostrare = filtro ? tutteLeNotizie.filter(n => n.fonte === filtro) : tutteLeNotizie;
            
            notizieDaMostrare.forEach(n => {
                contestoFeed += `[${n.fonte}] ${n.titolo}. `;
                cont.innerHTML += `
                    <article>
                        <span class="info-tag">Fonte: ${n.fonte} - Pubblicato il: ${n.dataTesto}</span>
                        <h3>${n.titolo}</h3>
                        <a href="${n.link}" target="_blank">Leggi notizia completa</a>
                    </article>`;
            });
            window.scrollTo(0, document.getElementById('main-content').offsetTop);
        }

        function salvaChiave() { localStorage.setItem('google_api_key', document.getElementById('api-key-input').value); document.getElementById('stato-chiave').innerText = "Chiave salvata!"; }
        function toggleWeb() { webAttiva = !webAttiva; document.getElementById('toggle-web').innerText = webAttiva ? "Ricerca Web: ATTIVA" : "Ricerca Web: OFF"; }
        
        async function inviaAI() {
            const key = localStorage.getItem('google_api_key');
            const msg = document.getElementById('input-chat').value;
            const resBox = document.getElementById('risposta-ai');
            resBox.innerHTML = "<h3>L'Assistente sta analizzando le notizie più recenti...</h3>";
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({messaggio: msg, contesto: contestoFeed, webAttiva, apiKey: key, searchId: SEARCH_ID})
            });
            const data = await res.json();
            resBox.innerHTML = `<h3>Risposta:</h3><div>${data.risposta}</div>`;
        }
    </script>
</body>
</html>