<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Edicola Valentina</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; line-height: 1.6; max-width: 1000px; margin: auto; background: #fdfdfd; color: #1a1a1a; }
        button { padding: 12px; margin: 5px; font-size: 1.1rem; cursor: pointer; border: 2px solid #333; border-radius: 8px; background: #fff; font-weight: bold; }
        .btn-filtro { background: #eef6ff; border: 2px solid #005a87; font-size: 1rem; color: #005a87; }
        .chat-box { background: #fff; padding: 25px; border: 4px solid #005a87; border-radius: 8px; margin-top: 40px; }
        input { padding: 12px; font-size: 1.1rem; border: 2px solid #767676; border-radius: 4px; margin: 5px 0; }
        section { border-bottom: 2px solid #eee; padding: 20px 0; }
        article { border-left: 8px solid #005a87; padding: 15px; margin-bottom: 15px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .info-tag { font-weight: bold; color: #d93025; font-size: 1.1rem; display: block; margin-bottom: 5px; }
    </style>
</head>
<body>
    <header><h1>La mia Edicola: Valentina</h1></header>

    <section aria-labelledby="h-config">
        <h2 id="h-config">1. Configurazione</h2>
        <input type="password" id="api-key-input" placeholder="Chiave API Gemini">
        <button onclick="salvaChiave()">Salva</button>
        <p id="stato-chiave" aria-live="polite"></p>
    </section>

    <section aria-labelledby="h-email">
        <h2 id="h-email">2. Analisi Email Thunderbird</h2>
        <label for="input-file">Carica file .txt delle email:</label><br>
        <input type="file" id="input-file" accept=".txt">
        <button onclick="caricaEmail()">Carica e Analizza</button>
    </section>

    <section aria-labelledby="h-feed">
        <h2 id="h-feed">3. Categorie Notizie</h2>
        <nav>
            <button onclick="caricaGruppo('ciechi')">Ciechi</button>
            <button onclick="caricaGruppo('news')">News Nazionali</button>
            <button onclick="caricaGruppo('approfondimenti')">Approfondimenti</button>
            <button onclick="caricaGruppo('psicologia')">Psicologia</button>
            <button onclick="caricaGruppo('roma')">Roma</button>
        </nav>
    </section>

    <section id="sezione-filtri" style="display:none;" aria-labelledby="h-filtri">
        <h3 id="h-filtri">Filtra per sito specifico:</h3>
        <div id="container-filtri"></div>
    </section>

    <main id="main-content" aria-live="polite">
        <h2 id="titolo-sezione">Nessuna categoria selezionata</h2>
        <div id="container-notizie"></div>
    </main>

    <section class="chat-box" aria-labelledby="h-chat">
        <h2 id="h-chat">4. Chiedi all'Assistente Gemini 3 Pro</h2>
        <button id="btn-web-toggle" onclick="toggleWeb()">Ricerca Web Online: OFF</button><br><br>
        <label for="input-chat">Domanda sui feed o su internet:</label><br>
        <input type="text" id="input-chat" style="width: 80%;">
        <button onclick="inviaDomanda()">Invia</button>
        <div id="risposta-ai" aria-live="assertive" style="margin-top: 20px;"></div>
    </section>

    <script>
        let tutteLeNotizie = [];
        let contestoCorrente = "";
        let webAttiva = false;

        const feedMap = {
            ciechi: [
                {n: "Reddit Blind", u: "https://www.reddit.com/r/Blind.rss"},
                {n: "NVDA-it", u: "https://groups.io/g/nvda-it/rss"},
                {n: "AppleVis", u: "https://www.applevis.com/blog/feed"}
            ],
            news: [
                {n: "ANSA", u: "https://www.ansa.it/sito/ansait_rss.xml"},
                {n: "Sole 24 Ore", u: "https://www.ilsole24ore.com/rss/italia.xml"},
                {n: "la Repubblica", u: "https://www.repubblica.it/rss/cronaca/rss2.0.xml"}
            ],
            approfondimenti: [
                {n: "Il Post", u: "https://www.ilpost.it/feed/"},
                {n: "Internazionale", u: "https://www.internazionale.it/rss/all"},
                {n: "Valigia Blu", u: "https://www.valigiablu.it/feed/"},
                {n: "Open", u: "https://www.open.online/feed/"},
                {n: "Il Tascabile", u: "https://www.iltascabile.com/feed/"}
            ],
            psicologia: [
                {n: "State of Mind", u: "https://www.stateofmind.it/category/articoli/feed/"},
                {n: "Mind Le Scienze", u: "https://www.lescienze.it/topics/mente-e-cervello/rss"},
                {n: "Doppiozero Psiche", u: "https://www.doppiozero.com/tag/psicologia/feed/"}
            ],
            roma: [
                {n: "Corriere Roma", u: "https://www.corriere.it/dynamic-feed/rss/section/roma.xml"},
                {n: "RomaToday", u: "https://www.romatoday.it/rss"},
                {n: "ATAC", u: "https://www.atac.roma.it/feeds/lo-stato-del-servizio-in-tempo-reale"}
            ]
        };

        function formattaData(dr) {
            const d = new Date(dr);
            const adesso = new Date();
            const ora = d.toLocaleString('it-IT', { hour: '2-digit', minute: '2-digit' });
            return (adesso.toDateString() === d.toDateString()) ? `Oggi, ${ora}` : `${d.toLocaleString('it-IT', { day: 'numeric', month: 'long' })}, ${ora}`;
        }

        async function caricaGruppo(cat) {
            tutteLeNotizie = [];
            const contNotizie = document.getElementById('container-notizie');
            const contFiltri = document.getElementById('container-filtri');
            const sezFiltri = document.getElementById('sezione-filtri');
            
            document.getElementById('titolo-sezione').innerText = `Caricamento categoria ${cat}...`;
            contNotizie.innerHTML = "";
            contFiltri.innerHTML = "";
            sezFiltri.style.display = "block";

            // Creiamo subito i pulsanti filtro per ogni sito del gruppo
            const btnAll = document.createElement('button');
            btnAll.innerText = "Mostra TUTTI i siti";
            btnAll.className = "btn-filtro";
            btnAll.onclick = () => renderizza();
            contFiltri.appendChild(btnAll);

            feedMap[cat].forEach(sito => {
                const btn = document.createElement('button');
                btn.className = "btn-filtro";
                btn.innerText = sito.n;
                btn.onclick = () => renderizza(sito.n);
                contFiltri.appendChild(btn);
            });

            // Scarichiamo i dati
            for (const sito of feedMap[cat]) {
                try {
                    const r = await fetch(`/api/fetch-rss?url=${encodeURIComponent(sito.u)}`);
                    const xml = await r.text();
                    const xmlDoc = new DOMParser().parseFromString(xml, "text/xml");
                    Array.from(xmlDoc.querySelectorAll("item")).forEach(item => {
                        const dr = item.querySelector("pubDate")?.textContent || "";
                        tutteLeNotizie.push({ 
                            fonte: sito.n, 
                            titolo: item.querySelector("title")?.textContent || "No titolo", 
                            data: formattaData(dr), 
                            ts: new Date(dr).getTime() || 0,
                            link: item.querySelector("link")?.textContent || "#"
                        });
                    });
                } catch (e) { console.log("Errore caricamento: " + sito.n); }
            }

            tutteLeNotizie.sort((a,b) => b.ts - a.ts);
            renderizza();
            document.getElementById('titolo-sezione').innerText = `Categoria ${cat} pronta.`;
        }

        function renderizza(filtro = null) {
            const cont = document.getElementById('container-notizie');
            cont.innerHTML = "";
            contestoCorrente = "";
            const newsMostrate = filtro ? tutteLeNotizie.filter(n => n.fonte === filtro) : tutteLeNotizie;
            
            newsMostrate.forEach(n => {
                contestoCorrente += `[${n.fonte}] ${n.titolo}. `;
                cont.innerHTML += `<article><span class="info-tag">${n.fonte}, ${n.data}</span><h3>${n.titolo}</h3><a href="${n.link}" target="_blank">Apri notizia</a></article>`;
            });
            window.scrollTo(0, document.getElementById('main-content').offsetTop);
        }

        function caricaEmail() {
            const file = document.getElementById('input-file').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                contestoCorrente = e.target.result;
                document.getElementById('risposta-ai').innerHTML = "<h3>Email caricate. Chiedi pure a Gemini.</h3>";
            };
            reader.readAsText(file);
        }

        function toggleWeb() {
            webAttiva = !webAttiva;
            document.getElementById('btn-web-toggle').innerText = webAttiva ? "Ricerca Web Online: ATTIVA" : "Ricerca Web Online: OFF";
        }

        async function inviaDomanda() {
            const key = localStorage.getItem('google_api_key');
            const msg = document.getElementById('input-chat').value;
            const resBox = document.getElementById('risposta-ai');
            resBox.innerHTML = "<h3>Analisi in corso...</h3>";

            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messaggio: msg, contesto: contestoCorrente, apiKey: key, webAttiva: webAttiva })
            });
            const data = await res.json();
            resBox.innerHTML = `<div>${data.risposta}</div>`;
        }

        function salvaChiave() { localStorage.setItem('google_api_key', document.getElementById('api-key-input').value); alert("Chiave salvata!"); }
    </script>
</body>
</html>
