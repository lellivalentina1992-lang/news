<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Edicola Valentina</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; line-height: 1.6; max-width: 1000px; margin: auto; background: #fdfdfd; color: #1a1a1a; }
        button { padding: 12px; margin: 5px; font-size: 1.1rem; cursor: pointer; border: 2px solid #333; border-radius: 8px; background: #fff; font-weight: bold; }
        .btn-tg { background: #005a87; color: white; border: none; width: 100%; margin-top: 10px; min-height: 60px; font-size: 1.2rem; }
        input { padding: 12px; font-size: 1.1rem; margin: 10px 0; border: 2px solid #767676; border-radius: 4px; }
        .input-ore { width: 60px; text-align: center; }
        section { border-bottom: 3px solid #eee; padding: 20px 0; }
        article { border-left: 8px solid #005a87; padding: 15px; margin-bottom: 25px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .info-tag { font-weight: bold; color: #d93025; font-size: 1.1rem; display: block; margin-bottom: 5px; }
        .chat-area { background: #eef6ff; padding: 25px; border: 2px solid #005a87; border-radius: 8px; margin-top: 40px; }
    </style>
</head>
<body>
    <header><h1>Edicola Valentina</h1></header>

    <section>
        <h2>Configurazione</h2>
        <label for="api-key-input">Inserisci Chiave API:</label><br>
        <input type="password" id="api-key-input" style="width: 80%;">
        <button onclick="salvaChiave()">Salva Chiave</button>
        <p id="stato-chiave" aria-live="polite"></p>
    </section>

    <section>
        <h2>Categorie Feed</h2>
        <nav>
            <button onclick="caricaTuttoIlGruppo('ciechi')">Ciechi</button>
            <button onclick="caricaTuttoIlGruppo('news')">News Nazionali</button>
            <button onclick="caricaTuttoIlGruppo('approfondimenti')">Approfondimenti</button>
            <button onclick="caricaTuttoIlGruppo('psicologia')">Psicologia</button>
            <button onclick="caricaTuttoIlGruppo('roma')">Roma</button>
            <button onclick="caricaTuttoIlGruppo('tecnologia')">Tecnologia</button>
        </nav>
    </section>

    <section id="sezione-filtri" style="display:none;">
        <h3>Filtra per sito specifico</h3>
        <div id="container-filtri"></div>
    </section>

    <main id="main-content" aria-live="polite">
        <h2 id="titolo-sezione">Scegli una categoria</h2>
        <div id="container-notizie"></div>
    </main>

    <section class="chat-area">
        <h2>Assistente Gemini 3 Pro</h2>
        
        <div style="margin-bottom: 20px;">
            <label for="input-ore">Quante ore vuoi analizzare per il TG? </label>
            <input type="number" id="input-ore" class="input-ore" value="24" min="1" max="168">
            <span>ore</span>
        </div>

        <button class="btn-tg" onclick="generaTG()">Genera TG Personalizzato (Testo Lungo)</button>
        
        <div style="margin-top: 20px;">
            <label for="input-chat">Fai una domanda specifica:</label><br>
            <input type="text" id="input-chat" style="width: 80%;" placeholder="Es: Riassumi solo le news su ATAC">
            <button onclick="inviaAI()">Invia</button>
        </div>

        <div id="risposta-ai" aria-live="assertive" style="margin-top: 20px;"></div>
    </section>

    <script>
        let tutteLeNotizie = [];
        let contestoFeedPerAI = "";

        const feedMap = {
            ciechi: [{n:"Reddit Blind", u:"https://www.reddit.com/r/Blind.rss"}, {n:"NVDA-it", u:"https://groups.io/g/nvda-it/rss"}, {n:"AppleVis Blogs", u:"https://www.applevis.com/blog/feed"}],
            news: [{n:"ANSA", u:"https://www.ansa.it/sito/ansait_rss.xml"}, {n:"Sole 24 Ore", u:"https://www.ilsole24ore.com/rss/italia.xml"}, {n:"la Repubblica", u:"https://www.repubblica.it/rss/cronaca/rss2.0.xml"}],
            approfondimenti: [{n:"Il Post", u:"https://www.ilpost.it/feed/"}, {n:"Valigia Blu", u:"https://www.valigiablu.it/feed/"}, {n:"Il Tascabile", u:"https://www.iltascabile.com/feed/"}, {n:"Wired Diritti", u:"https://www.wired.it/feed/rss/internet/diritti/"}],
            psicologia: [{n:"State of Mind", u:"https://www.stateofmind.it/category/articoli/feed/"}, {n:"Mind Le Scienze", u:"https://www.lescienze.it/topics/mente-e-cervello/rss"}, {n:"Doppiozero Psiche", u:"https://www.doppiozero.com/tag/psicologia/feed/"}],
            roma: [{n:"Corriere Roma", u:"https://www.corriere.it/dynamic-feed/rss/section/roma.xml"}, {n:"RomaToday", u:"https://www.romatoday.it/rss"}, {n:"ATAC", u:"https://www.atac.roma.it/feeds/lo-stato-del-servizio-in-tempo-reale"}, {n:"Tiburno TV", u:"https://tiburno.tv/feed/"}, {n:"Canale Dieci", u:"https://canaledieci.it/feed/"}, {n:"TGR Lazio", u:"https://www.rainews.it/tgr/lazio/rss/tutti"}],
            tecnologia: [{n:"Reddit technews", u:"https://www.reddit.com/r/technews.rss"}, {n:"Google News AI", u:"https://news.google.com/rss/search?q=AI&hl=it&gl=IT&ceid=IT:it"}]
        };

        function formattaDataVeloce(stringaData) {
            if (!stringaData) return "Data non disponibile";
            const d = new Date(stringaData);
            if (isNaN(d.getTime())) return "Data recente";
            const adesso = new Date();
            const ora = d.toLocaleString('it-IT', { hour: '2-digit', minute: '2-digit' });
            if (adesso.toDateString() === d.toDateString()) return `Oggi, ${ora}`;
            return `${d.toLocaleString('it-IT', { day: 'numeric', month: 'long' })}, ${ora}`;
        }

        async function caricaTuttoIlGruppo(cat) {
            const contNotizie = document.getElementById('container-notizie');
            const contFiltri = document.getElementById('container-filtri');
            document.getElementById('titolo-sezione').innerText = `Caricamento: ${cat}...`;
            contNotizie.innerHTML = ""; contFiltri.innerHTML = "";
            document.getElementById('sezione-filtri').style.display = "block";
            tutteLeNotizie = [];

            const btnAll = document.createElement('button');
            btnAll.innerText = "Mostra tutti";
            btnAll.onclick = () => renderizzaNotizie();
            contFiltri.appendChild(btnAll);

            feedMap[cat].forEach(sito => {
                const btn = document.createElement('button');
                btn.innerText = sito.n;
                btn.onclick = () => renderizzaNotizie(sito.n);
                contFiltri.appendChild(btn);
            });

            const promesse = feedMap[cat].map(sito => 
                fetch(`/api/fetch-rss?url=${encodeURIComponent(sito.u)}`)
                .then(r => r.text())
                .then(xml => {
                    const xmlDoc = new DOMParser().parseFromString(xml, "text/xml");
                    const items = Array.from(xmlDoc.querySelectorAll("item"));
                    items.forEach(item => {
                        const t = item.querySelector("title")?.textContent || "Senza titolo";
                        const l = item.querySelector("link")?.textContent || "#";
                        const dRaw = item.querySelector("pubDate")?.textContent || item.querySelector("date")?.textContent || "";
                        tutteLeNotizie.push({ 
                            fonte: sito.n, titolo: t, link: l, 
                            dataTesto: formattaDataVeloce(dRaw),
                            timestamp: new Date(dRaw).getTime() || 0
                        });
                    });
                }).catch(() => console.log("Errore: " + sito.n))
            );

            await Promise.all(promesse);
            tutteLeNotizie.sort((a, b) => b.timestamp - a.timestamp);
            renderizzaNotizie();
            document.getElementById('titolo-sezione').innerText = `Categoria ${cat} pronta.`;
        }

        function renderizzaNotizie(filtro = null) {
            const cont = document.getElementById('container-notizie');
            cont.innerHTML = "";
            const notizieDaMostrare = filtro ? tutteLeNotizie.filter(n => n.fonte === filtro) : tutteLeNotizie;
            notizieDaMostrare.forEach(n => {
                cont.innerHTML += `<article><span class="info-tag">${n.fonte}, ${n.dataTesto}</span><h3>${n.titolo}</h3><a href="${n.link}" target="_blank">Apri</a></article>`;
            });
        }

        async function generaTG() {
            if (tutteLeNotizie.length === 0) { alert("Carica prima una categoria!"); return; }
            const resBox = document.getElementById('risposta-ai');
            const oreScelte = parseInt(document.getElementById('input-ore').value) || 24;
            
            resBox.innerHTML = `<h3>Gemini 3 Pro analizza le ultime ${oreScelte} ore...</h3>`;
            
            const limiteTempo = Date.now() - (oreScelte * 60 * 60 * 1000);
            const notizieFiltrate = tutteLeNotizie.filter(n => n.timestamp > limiteTempo);

            if (notizieFiltrate.length === 0) {
                resBox.innerHTML = `<h3>Nessuna notizia trovata nelle ultime ${oreScelte} ore. Prova ad aumentare il tempo.</h3>`;
                return;
            }

            let contestoTesto = notizieFiltrate.map(n => `[${n.fonte}, ${n.dataTesto}] ${n.titolo}`).join(". ");
            const promptSpeciale = `Genera un TG lungo e narrativo basato sulle news caricate. Sii molto discorsiva.`;
            
            await inviaAI(promptSpeciale, contestoTesto);
        }

        async function inviaAI(istruzione = null, contestoOverride = null) {
            const key = localStorage.getItem('google_api_key');
            const msg = istruzione || document.getElementById('input-chat').value;
            const contestoDati = contestoOverride || tutteLeNotizie.map(n => `[${n.fonte}] ${n.titolo}`).join(". ");
            const resBox = document.getElementById('risposta-ai');

            try {
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messaggio: msg, contesto: contestoDati, apiKey: key })
                });
                const data = await response.json();
                resBox.innerHTML = `<h3>Il tuo TG Personalizzato:</h3><div>${data.risposta}</div>`;
            } catch (e) { resBox.innerHTML = "<h3>Errore API. Verifica la chiave.</h3>"; }
        }

        function salvaChiave() { localStorage.setItem('google_api_key', document.getElementById('api-key-input').value); alert("Chiave salvata!"); }
    </script>
</body>
</html>