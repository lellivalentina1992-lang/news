<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Edicola Valentina - Edizioni Speciali</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; line-height: 1.6; max-width: 1000px; margin: auto; background: #fdfdfd; color: #1a1a1a; }
        button { padding: 15px; margin: 10px 5px; font-size: 1.1rem; cursor: pointer; border: 2px solid #333; border-radius: 8px; background: #fff; font-weight: bold; width: 100%; text-align: left; }
        .btn-tg-1 { border-left: 15px solid #005a87; background: #f0f7ff; }
        .btn-tg-2 { border-left: 15px solid #28a745; background: #f0fff4; }
        .btn-tg-3 { border-left: 15px solid #6f42c1; background: #f5f0ff; }
        input { padding: 12px; font-size: 1.1rem; border: 2px solid #767676; border-radius: 4px; width: 80px; }
        .chat-area { background: #fff; padding: 25px; border: 3px solid #005a87; border-radius: 8px; margin-top: 40px; }
        article { border-bottom: 1px solid #eee; padding: 10px 0; }
    </style>
</head>
<body>
    <header><h1>Edicola Valentina: Scegli l'Edizione del TG</h1></header>

    <section>
        <h2>Configurazione e Ore</h2>
        <label for="input-ore">Analizza le ultime (ore):</label>
        <input type="number" id="input-ore" value="24">
        <p>Dopo aver scelto le ore, premi uno dei tre pulsanti qui sotto per generare il racconto.</p>
    </section>

    <section aria-label="Edizioni del TG">
        <button class="btn-tg-1" onclick="generaTGSettoriale(['ciechi', 'psicologia', 'tecnologia'], 'RICERCA E VITA QUOTIDIANA')">
            1. Genera TG Ricerca e Vita (Ciechi, Psicologia, Tech)
        </button>
        
        <button class="btn-tg-2" onclick="generaTGSettoriale(['news', 'roma'], 'ATTUALITÃ€ E TERRITORIO')">
            2. Genera TG Cronaca e Roma (News e Territorio)
        </button>

        <button class="btn-tg-3" onclick="generaTGSettoriale(['approfondimenti'], 'ANALISI E CULTURA')">
            3. Genera TG Approfondimenti (Analisi e Long-form)
        </button>
    </section>

    <main id="risposta-ai-container" class="chat-area" style="display:none;">
        <h2 id="titolo-tg-corrente">Il tuo TG</h2>
        <div id="risposta-ai" aria-live="assertive"></div>
    </main>

    <script>
        let tutteLeNotizie = [];
        const feedMap = {
            ciechi: [{n:"Reddit Blind", u:"https://www.reddit.com/r/Blind.rss"}, {n:"NVDA-it", u:"https://groups.io/g/nvda-it/rss"}, {n:"AppleVis", u:"https://www.applevis.com/blog/feed"}],
            news: [{n:"ANSA", u:"https://www.ansa.it/sito/ansait_rss.xml"}, {n:"Sole 24 Ore", u:"https://www.ilsole24ore.com/rss/italia.xml"}],
            approfondimenti: [{n:"Il Post", u:"https://www.ilpost.it/feed/"}, {n:"Valigia Blu", u:"https://www.valigiablu.it/feed/"}, {n:"Il Tascabile", u:"https://www.iltascabile.com/feed/"}],
            psicologia: [{n:"State of Mind", u:"https://www.stateofmind.it/category/articoli/feed/"}, {n:"Mind Le Scienze", u:"https://www.lescienze.it/topics/mente-e-cervello/rss"}, {n:"Doppiozero Psiche", u:"https://www.doppiozero.com/tag/psicologia/feed/"}],
            roma: [{n:"Corriere Roma", u:"https://www.corriere.it/dynamic-feed/rss/section/roma.xml"}, {n:"RomaToday", u:"https://www.romatoday.it/rss"}, {n:"ATAC", u:"https://www.atac.roma.it/feeds/lo-stato-del-servizio-in-tempo-reale"}, {n:"Tiburno TV", u:"https://tiburno.tv/feed/"}],
            tecnologia: [{n:"Reddit tech", u:"https://www.reddit.com/r/technews.rss"}, {n:"Google AI", u:"https://news.google.com/rss/search?q=AI&hl=it&gl=IT&ceid=IT:it"}]
        };

        async function scaricaFeed(listaCategorie) {
            tutteLeNotizie = [];
            let sitiDaScaricare = [];
            listaCategorie.forEach(cat => sitiDaScaricare = sitiDaScaricare.concat(feedMap[cat]));

            const promesse = sitiDaScaricare.map(sito => 
                fetch(`/api/fetch-rss?url=${encodeURIComponent(sito.u)}`)
                .then(r => r.text())
                .then(xml => {
                    const xmlDoc = new DOMParser().parseFromString(xml, "text/xml");
                    Array.from(xmlDoc.querySelectorAll("item")).forEach(item => {
                        const dRaw = item.querySelector("pubDate")?.textContent || "";
                        tutteLeNotizie.push({ 
                            fonte: sito.n, titolo: item.querySelector("title")?.textContent || "No titolo", 
                            timestamp: new Date(dRaw).getTime() || 0
                        });
                    });
                }).catch(() => console.log("Errore su: " + sito.n))
            );
            await Promise.all(promesse);
        }

        async function generaTGSettoriale(categorie, titoloTG) {
            const resBox = document.getElementById('risposta-ai');
            const ore = document.getElementById('input-ore').value;
            document.getElementById('risposta-ai-container').style.display = "block";
            document.getElementById('titolo-tg-corrente').innerText = "TG: " + titoloTG;
            
            resBox.innerHTML = `<h3>Caricamento delle fonti per ${titoloTG}...</h3>`;
            await scaricaFeed(categorie);

            const limite = Date.now() - (ore * 60 * 60 * 1000);
            const filtrate = tutteLeNotizie.filter(n => n.timestamp > limite);
            
            if (filtrate.length === 0) {
                resBox.innerHTML = "<h3>Nessuna notizia trovata in questa categoria nelle ultime " + ore + " ore.</h3>";
                return;
            }

            resBox.innerHTML = "<h3>Gemini 3 Pro sta scrivendo l'edizione: " + titoloTG + ". Attendi...</h3>";
            let contesto = filtrate.map(n => `[${n.fonte}] ${n.titolo}`).join(". ");
            
            const key = localStorage.getItem('google_api_key');
            const response = await fetch('/api/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messaggio: `Fai un TG esaustivo per la sezione ${titoloTG}. Includi OGNI dettaglio.`, contesto: contesto, apiKey: key })
            });
            const data = await response.json();
            resBox.innerHTML = `<div>${data.risposta}</div>`;
        }
    </script>
</body>
</html>