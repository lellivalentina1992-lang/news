<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Edicola Valentina - Versione Integrata</title>
    <style>
        body { font-family: system-ui, sans-serif; padding: 20px; line-height: 1.6; max-width: 1000px; margin: auto; background: #fdfdfd; color: #1a1a1a; }
        button { padding: 15px; margin: 5px; font-size: 1.1rem; cursor: pointer; border: 2px solid #333; border-radius: 8px; background: #fff; font-weight: bold; }
        input { padding: 12px; font-size: 1.1rem; margin: 10px 0; border: 2px solid #767676; border-radius: 4px; width: 85%; }
        section { border-bottom: 3px solid #eee; padding: 25px 0; }
        article { border-left: 8px solid #005a87; padding: 15px; margin-bottom: 25px; background: #fff; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .fonte-tag { font-weight: bold; color: #d93025; text-transform: uppercase; font-size: 0.85rem; display: block; margin-bottom: 5px; }
        .chat-area { background: #eef6ff; padding: 25px; border: 2px solid #005a87; border-radius: 8px; margin-top: 40px; }
    </style>
</head>
<body>

    <header><h1>La mia Edicola: Valentina</h1></header>

    <section style="background: #fff5f5; padding: 15px; border: 2px dashed #d93025;">
        <h2>Configurazione</h2>
        <input type="password" id="api-key-input" placeholder="Incolla API Key per la Chat">
        <button onclick="salvaChiave()">Salva Chiave</button>
        <p id="stato-chiave" aria-live="polite"></p>
    </section>

    <section aria-labelledby="titolo-feed">
        <h2 id="titolo-feed">I miei Feed (Scegli categoria)</h2>
        <nav aria-label="Categorie">
            <button onclick="caricaTuttoIlGruppo('ciechi')">‚ôø Ciechi</button>
            <button onclick="caricaTuttoIlGruppo('news')">üåç News Nazionali</button>
            <button onclick="caricaTuttoIlGruppo('approfondimenti')">üìë Approfondimenti</button>
            <button onclick="caricaTuttoIlGruppo('psicologia')">üß† Psicologia</button>
            <button onclick="caricaTuttoIlGruppo('roma')">üèôÔ∏è Roma</button>
            <button onclick="caricaTuttoIlGruppo('tecnologia')">üíª Tecnologia</button>
        </nav>
    </section>

    <main id="main-content" aria-live="polite">
        <h2 id="titolo-sezione">Scegli una categoria</h2>
        <div id="container-notizie"></div>
    </main>

    <section class="chat-area">
        <h2>Chiedi all'Assistente</h2>
        <button id="toggle-web" onclick="toggleWeb()">üåê Ricerca Web: OFF</button><br>
        <input type="text" id="input-chat" placeholder="Chiedi sui feed carichi...">
        <button onclick="inviaAI()" style="background: #005a87; color: white;">Invia</button>
        <div id="risposta-ai" aria-live="assertive" style="margin-top: 20px;"></div>
    </section>

    <script>
        let webAttiva = false;
        let contestoFeed = "";
        const SEARCH_ID = "43edcb6f7c3854b7a";

        const feedMap = {
            ciechi: [
                {n: "Reddit - r/Blind", u: "https://www.reddit.com/r/Blind.rss"},
                {n: "Reddit - r/Blind (Ricerca)", u: "https://www.reddit.com/r/Blind/search/.rss?q=android+OR+talkback+OR+screenreader&restrict_sr=1&sort=new"},
                {n: "Reddit - r/AudioGames", u: "https://www.reddit.com/r/AudioGames.rss"},
                {n: "Reddit - r/AssistiveTechnology", u: "https://www.reddit.com/r/AssistiveTechnology.rss"},
                {n: "Blind Android Users (Podcast)", u: "https://blindandroidusers.com/feed/podcast/"},
                {n: "Blind Android Users (Gruppo)", u: "https://groups.io/g/blindandroidusers/rss"},
                {n: "NVDA-it (Gruppo)", u: "https://groups.io/g/nvda-it/rss"},
                {n: "NVDA (Gruppo)", u: "https://nvda.groups.io/g/nvda/rss"},
                {n: "NVDA Addons (Gruppo)", u: "https://nvda-addons.groups.io/g/nvda-addons/rss"},
                {n: "JFW (Gruppo)", u: "https://jfw.groups.io/g/main/rss"},
                {n: "AppleVis: Blogs", u: "https://www.applevis.com/blog/feed"},
                {n: "AppleVis: Podcast", u: "https://www.applevis.com/podcasts/feed"}
            ],
            news: [
                {n: "ANSA", u: "https://www.ansa.it/sito/ansait_rss.xml"},
                {n: "la Repubblica", u: "https://www.repubblica.it/rss/cronaca/rss2.0.xml"},
                {n: "La Stampa", u: "https://www.lastampa.it/rss/copertina.xml"},
                {n: "Il Sole 24 Ore", u: "https://www.ilsole24ore.com/rss/italia.xml"},
                {n: "Il Messaggero", u: "https://www.ilmessaggero.it/rss.php"},
                {n: "Sky TG24 Home", u: "https://tg24.sky.it/rss/tg24.xml"},
                {n: "Sky TG24 Cronaca", u: "https://tg24.sky.it/rss/tg24_cronaca.xml"},
                {n: "Sky TG24 Mondo", u: "https://tg24.sky.it/rss/tg24_mondo.xml"}
            ],
            approfondimenti: [
                {n: "Internazionale", u: "https://www.internazionale.it/sitemaps/rss.xml"},
                {n: "Open", u: "https://www.open.online/feed/"},
                {n: "Valigia Blu", u: "https://www.valigiablu.it/feed/"},
                {n: "Scomodo", u: "https://scomodo.org/feed/"},
                {n: "The Vision", u: "https://thevision.com/feed/"},
                {n: "Rivista Studio", u: "https://www.rivistastudio.com/feed/"},
                {n: "Bufale.net", u: "https://www.bufale.net/feed/"},
                {n: "Formiche", u: "https://formiche.net/feed/"},
                {n: "Pandora Rivista", u: "https://www.pandorarivista.it/feed/"},
                {n: "Domani", u: "https://www.editorialedomani.it/rss"},
                {n: "L'Indipendente", u: "https://www.lindipendente.online/feed/"},
                {n: "2duerighe", u: "https://www.2duerighe.com/feed/"},
                {n: "Giano News", u: "https://www.giano.news/feed/"},
                {n: "Il Post", u: "https://www.ilpost.it/feed/"},
                {n: "Wired - Diritti", u: "https://www.wired.it/feed/rss/internet/diritti/"},
                {n: "Il Tascabile", u: "https://www.iltascabile.com/feed/"},
                {n: "All Music Italia", u: "https://www.allmusicitalia.it/feed"},
                {n: "Digital-News", u: "https://www.digital-news.it/rss.php"},
                {n: "FM-World", u: "https://www.fm-world.it/feed/"}
            ],
            psicologia: [
                {n: "State of Mind", u: "https://www.stateofmind.it/category/articoli/feed/"},
                {n: "Mind - Le Scienze", u: "https://www.lescienze.it/topics/mente-e-cervello/rss"},
                {n: "Doppiozero - Psiche", u: "https://www.doppiozero.com/tag/psicologia/feed/"},
                {n: "La Mente √® Meravigliosa", u: "https://lamenteemeravigliosa.it/feed/"},
                {n: "Psypedia", u: "https://www.psypedia.it/feed/"},
                {n: "Psiche - Santagostino", u: "https://psiche.santagostino.it/feed/"},
                {n: "Psychology Today", u: "https://www.psychologytoday.com/intl/front/feed"},
                {n: "PsyPost", u: "https://www.psypost.org/feed"}
            ],
            roma: [
                {n: "Corriere - Roma", u: "https://www.corriere.it/dynamic-feed/rss/section/roma.xml"},
                {n: "RomaToday", u: "https://www.romatoday.it/rss"},
                {n: "ANSA - Lazio", u: "https://www.ansa.it/lazio/notizie/lazio_rss.xml"},
                {n: "TGR Lazio", u: "https://www.rainews.it/tgr/lazio/rss/tutti"},
                {n: "Tiburno TV", u: "https://tiburno.tv/feed/"},
                {n: "Canale Dieci", u: "https://canaledieci.it/feed/"},
                {n: "Il Faro Online", u: "https://www.ilfaroonline.it/feed/"},
                {n: "Radio Roma", u: "https://www.radioroma.it/feed/"},
                {n: "Roma Sociale", u: "https://romasociale.com/feed/"},
                {n: "ATAC", u: "https://www.atac.roma.it/feeds/lo-stato-del-servizio-in-tempo-reale"}
            ],
            tecnologia: [
                {n: "Reddit - r/technews", u: "https://www.reddit.com/r/technews.rss"},
                {n: "Google News - AI", u: "https://news.google.com/rss/search?q=intelligenza+artificiale+OR+Gemini+OR+ChatGPT&hl=it&gl=IT&ceid=IT:it"},
                {n: "Sky TG24 - Tecnologia", u: "https://tg24.sky.it/rss/tg24_tecnologia.xml"}
            ]
        };

        async function caricaTuttoIlGruppo(cat) {
            const cont = document.getElementById('container-notizie');
            const tit = document.getElementById('titolo-sezione');
            tit.innerText = `üîÑ Aggiornamento in corso: ${cat}...`;
            cont.innerHTML = "";
            contestoFeed = "";

            const promesse = feedMap[cat].map(sito => 
                fetch(`/api/fetch-rss?url=${encodeURIComponent(sito.u)}`)
                .then(r => r.text())
                .then(xml => {
                    const items = new DOMParser().parseFromString(xml, "text/xml").querySelectorAll("item");
                    items.forEach(item => {
                        const t = item.querySelector("title")?.textContent || "Senza titolo";
                        const l = item.querySelector("link")?.textContent || "#";
                        contestoFeed += `[${sito.n}] ${t}. `;
                        cont.innerHTML += `
                            <article>
                                <span class="fonte-tag">${sito.n}</span>
                                <h3>${t}</h3>
                                <a href="${l}" target="_blank">Leggi l'articolo completo</a>
                            </article>`;
                    });
                }).catch(() => console.log("Errore su: " + sito.n))
            );
            await Promise.all(promesse);
            tit.innerText = `‚úÖ Categoria ${cat} caricata. Usa il tasto H per navigare.`;
        }

        function salvaChiave() { localStorage.setItem('google_api_key', document.getElementById('api-key-input').value); document.getElementById('stato-chiave').innerText = "Chiave salvata!"; }
        function toggleWeb() { webAttiva = !webAttiva; document.getElementById('toggle-web').innerText = webAttiva ? "üåê Ricerca Web: ATTIVA" : "üåê Ricerca Web: OFF"; }
        
        async function inviaAI() {
            const key = localStorage.getItem('google_api_key');
            const msg = document.getElementById('input-chat').value;
            const resBox = document.getElementById('risposta-ai');
            resBox.innerHTML = "<h3>L'Assistente sta analizzando i tuoi feed...</h3>";
            const res = await fetch('/api/chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({messaggio: msg, contesto: contestoFeed, webAttiva, apiKey: key, searchId: SEARCH_ID})
            });
            const data = await res.json();
            resBox.innerHTML = `<h3>Risposta:</h3><div>${data.risposta}</div>`;
        }
    </script>
</body>
</html>